<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spotify AI DJ</title>
    <style>
        /* (All your styles remain the same, omitted here for brevity) */
    </style>
</head>
<body>
    <div class="container">
        <h1>üéµ Spotify AI DJ</h1>
        
        <div class="setup-instructions" id="authInstructions">
            <h3>üéß Welcome to Spotify AI DJ</h3>
            <p>This app creates seamless transitions between your Spotify tracks using AI analysis of tempo, key, and energy levels.</p>
            
            <div class="auth-methods">
                <div class="auth-method">
                    <h4>üéµ Login with Spotify</h4>
                    <p>The easiest way to get started! Uses the secure Authorization Code Flow with PKCE for authentication.</p>
                    <button id="pkceLoginBtn" class="btn">üîê Login with Spotify</button>
                </div>
            </div>
        </div>
        
        <div class="auth-section">
            <div id="authStatus"></div>
            <button id="logoutBtn" class="btn secondary" style="display: none;">Logout</button>
            <div id="connectionStatus" class="status disconnected">Not Connected</div>
        </div>
        
        <div class="player-section" id="playerSection" style="display: none;">
            <h2>Now Playing</h2>
            <div class="current-track">
                <img id="trackImage" class="track-image" src="" alt="Album cover">
                <div class="track-info">
                    <h3 id="trackName">-</h3>
                    <p id="trackArtist">-</p>
                    <p id="trackProgress">-</p>
                </div>
            </div>
            <div class="controls">
                <button id="prevBtn" class="btn">‚èÆÔ∏è Previous</button>
                <button id="playPauseBtn" class="btn">‚è∏Ô∏è Pause</button>
                <button id="nextBtn" class="btn">‚è≠Ô∏è Skip</button>
            </div>
        </div>
    </div>

    <script>
        const CLIENT_ID = 'e60ede83721246198bf4fe8a9bee8ca8';
        const REDIRECT_URI = 'https://domdpelikan.github.io/spotify-ai-dj/';
        const SCOPES = [
            'user-read-playback-state',
            'user-modify-playback-state', 
            'user-read-currently-playing',
            'streaming',
            'user-read-private',
            'user-read-email'
        ].join(' ');

        let accessToken = null;
        let refreshToken = null;
        let tokenExpiry = null;

        document.addEventListener('DOMContentLoaded', () => {
            setupEventListeners();
            handleAuthCallback();
        });

        function setupEventListeners() {
            document.getElementById('pkceLoginBtn').addEventListener('click', startPKCEFlow);
            document.getElementById('logoutBtn').addEventListener('click', logout);
        }

        async function startPKCEFlow() {
            const codeVerifier = generateRandomString(128);
            localStorage.setItem('code_verifier', codeVerifier);

            const codeChallenge = await generateCodeChallenge(codeVerifier);
            const state = generateRandomString(16);
            localStorage.setItem('spotify_auth_state', state);

            const authUrl = new URL('https://accounts.spotify.com/authorize');
            authUrl.searchParams.set('response_type', 'code');
            authUrl.searchParams.set('client_id', CLIENT_ID);
            authUrl.searchParams.set('scope', SCOPES);
            authUrl.searchParams.set('redirect_uri', REDIRECT_URI);
            authUrl.searchParams.set('state', state);
            authUrl.searchParams.set('code_challenge_method', 'S256');
            authUrl.searchParams.set('code_challenge', codeChallenge);

            window.location.href = authUrl.toString();
        }

        async function handleAuthCallback() {
            const urlParams = new URLSearchParams(window.location.search);
            const code = urlParams.get('code');
            const state = urlParams.get('state');
            const error = urlParams.get('error');

            if (error) {
                showError(`Authentication failed: ${error}`);
                return;
            }

            if (code) {
                const storedState = localStorage.getItem('spotify_auth_state');
                if (state !== storedState) {
                    showError('Authentication state mismatch. Please try again.');
                    return;
                }

                window.history.replaceState({}, document.title, REDIRECT_URI);
                await exchangeCodeForTokens(code);
            }
        }

        async function exchangeCodeForTokens(code) {
            const codeVerifier = localStorage.getItem('code_verifier');
            if (!codeVerifier) {
                showError('Missing code verifier');
                return;
            }

            const body = new URLSearchParams({
                grant_type: 'authorization_code',
                code,
                redirect_uri: REDIRECT_URI,
                client_id: CLIENT_ID,
                code_verifier: codeVerifier
            });

            const response = await fetch('https://accounts.spotify.com/api/token', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body
            });

            if (!response.ok) {
                const errorData = await response.json();
                showError(errorData.error_description || 'Token exchange failed');
                return;
            }

            const tokens = await response.json();
            accessToken = tokens.access_token;
            refreshToken = tokens.refresh_token;
            tokenExpiry = Date.now() + (tokens.expires_in * 1000);

            showSuccess('Connected to Spotify!');
            document.getElementById('authInstructions').style.display = 'none';
            document.getElementById('logoutBtn').style.display = 'inline-block';
        }

        function logout() {
            accessToken = null;
            refreshToken = null;
            tokenExpiry = null;
            localStorage.removeItem('spotify_tokens');
            localStorage.removeItem('code_verifier');
            localStorage.removeItem('spotify_auth_state');

            document.getElementById('authInstructions').style.display = 'block';
            document.getElementById('logoutBtn').style.display = 'none';
        }

        function generateRandomString(length) {
            const possible = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
            const values = crypto.getRandomValues(new Uint8Array(length));
            return Array.from(values).map(x => possible[x % possible.length]).join('');
        }

        async function generateCodeChallenge(verifier) {
            const data = new TextEncoder().encode(verifier);
            const digest = await crypto.subtle.digest('SHA-256', data);
            return btoa(String.fromCharCode(...new Uint8Array(digest)))
                .replace(/\+/g, '-')
                .replace(/\//g, '_')
                .replace(/=+$/, '');
        }

        function showError(message) {
            document.getElementById('authStatus').innerHTML = `<div class="error-message">${message}</div>`;
        }

        function showSuccess(message) {
            document.getElementById('authStatus').innerHTML = `<div class="success-message">${message}</div>`;
        }
    </script>
</body>
</html>

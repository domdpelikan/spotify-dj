<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Spotify DJ Crossfade</title>
  <style>
    body {
      background: #121212;
      color: #fff;
      font-family: sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      padding: 20px;
    }
    h1 {
      font-size: 2em;
      margin-bottom: 20px;
    }
    button {
      padding: 10px 20px;
      font-size: 1em;
      margin: 5px;
    }
    #status {
      margin-top: 15px;
    }
  </style>
</head>
<body>
  <h1>Spotify DJ Crossfade</h1>
  <button onclick="login()">Login with Spotify</button>
  <button onclick="performBeatMatchedSkip()">Crossfade Skip</button>
  <div id="status">Status: Not connected</div>

  <script>
    const CLIENT_ID = 'e60ede83721246198bf4fe8a9bee8ca8';
    const REDIRECT_URI = window.location.origin + window.location.pathname;
    const SCOPES = [
      'user-read-playback-state',
      'user-modify-playback-state',
      'user-read-currently-playing'
    ];
    let accessToken = null;
    let lastTrackId = null;

    async function generateCodeChallenge(codeVerifier) {
      const data = new TextEncoder().encode(codeVerifier);
      const digest = await crypto.subtle.digest('SHA-256', data);
      return btoa(String.fromCharCode(...new Uint8Array(digest)))
        .replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
    }

    function generateRandomString(length) {
      const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
      return Array.from(crypto.getRandomValues(new Uint8Array(length)))
        .map(x => chars[x % chars.length]).join('');
    }

    async function login() {
      const state = generateRandomString(16);
      const codeVerifier = generateRandomString(64);
      const codeChallenge = await generateCodeChallenge(codeVerifier);
      sessionStorage.setItem('code_verifier', codeVerifier);
      sessionStorage.setItem('state', state);
      const params = new URLSearchParams({
        response_type: 'code',
        client_id: CLIENT_ID,
        scope: SCOPES.join(' '),
        redirect_uri: REDIRECT_URI,
        state,
        code_challenge_method: 'S256',
        code_challenge: codeChallenge
      });
      window.location.href = 'https://accounts.spotify.com/authorize?' + params.toString();
    }

    async function handleRedirect() {
      const params = new URLSearchParams(window.location.search);
      const code = params.get('code');
      const state = params.get('state');
      const storedState = sessionStorage.getItem('state');
      if (code && state === storedState) {
        const codeVerifier = sessionStorage.getItem('code_verifier');
        const result = await fetch('https://accounts.spotify.com/api/token', {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
          body: new URLSearchParams({
            grant_type: 'authorization_code',
            code,
            redirect_uri: REDIRECT_URI,
            client_id: CLIENT_ID,
            code_verifier: codeVerifier
          })
        });
        const data = await result.json();
        accessToken = data.access_token;
        sessionStorage.setItem('access_token', accessToken);
        history.replaceState(null, '', REDIRECT_URI);
        document.getElementById('status').innerText = 'Status: Connected';
        monitorPlayback();
      }
    }

    async function spotifyRequest(endpoint, method = 'GET') {
      const result = await fetch(`https://api.spotify.com/v1${endpoint}`, {
        method,
        headers: {
          Authorization: 'Bearer ' + accessToken
        }
      });
      return result.ok ? await result.json() : null;
    }

    async function spotifyPut(endpoint) {
      await fetch(`https://api.spotify.com/v1${endpoint}`, {
        method: 'PUT',
        headers: { Authorization: 'Bearer ' + accessToken }
      });
    }

    async function spotifyPost(endpoint) {
      await fetch(`https://api.spotify.com/v1${endpoint}`, {
        method: 'POST',
        headers: { Authorization: 'Bearer ' + accessToken }
      });
    }

    async function fadeVolume(target, duration = 1000) {
      const steps = 20;
      const delay = duration / steps;
      const state = await spotifyRequest('/me/player');
      const startVol = state.device.volume_percent;
      const diff = target - startVol;
      for (let i = 1; i <= steps; i++) {
        const vol = startVol + diff * (i / steps);
        await spotifyPut(`/me/player/volume?volume_percent=${Math.round(vol)}`);
        await new Promise(r => setTimeout(r, delay));
      }
    }

    async function performBeatMatchedSkip() {
      if (!accessToken) return;
      document.getElementById('status').innerText = 'Mixing...';

      const queue = await spotifyRequest('/me/player/queue');
      const next = queue?.queue?.[0];
      const cueTime = 16000;

      if (!next) {
        document.getElementById('status').innerText = 'No track in queue!';
        return;
      }

      await fadeVolume(0, 1000);
      await spotifyPost('/me/player/next');

      setTimeout(async () => {
        await spotifyPut(`/me/player/seek?position_ms=${cueTime}`);
        await fadeVolume(100, 1000);
        document.getElementById('status').innerText = 'Mix complete!';
      }, 200);
    }

    async function monitorPlayback() {
      setInterval(async () => {
        const playback = await spotifyRequest('/me/player');
        if (!playback || !playback.item) return;

        const currentId = playback.item.id;
        const progress = playback.progress_ms;

        if (currentId !== lastTrackId && progress < 2000) {
          setTimeout(() => {
            spotifyPut('/me/player/seek?position_ms=16000');
          }, 200);
          lastTrackId = currentId;
        }
      }, 1000);
    }

    window.onload = async () => {
      accessToken = sessionStorage.getItem('access_token');
      if (!accessToken) await handleRedirect();
      else monitorPlayback();
    };
  </script>
</body>
</html>
